<html>
    <head>
        <title>Administration</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body class="admin-page-body">

        <div id="adminTitleBar" class="admin-title-bar">
            <a id="database-button" onclick="setSelectedTab('database-tab', 'database-button')">Database</a>
            <a id="marketplace-button">Marketplace</a>
            <a id="createpost-button" onclick="setSelectedTab('createpost-tab', 'createpost-button')">Create Post</a>
            <a href="/">Home Page</a>
            <a href="/logout">Logout</a>
        </div>

        <div id="adminContainer" class="admin-container">

            <div id="database-tab" style="display: none;">
                <div class="admin-table-container" style="float: left;">
                    <table id="usersTable" class="admin-table">
                        <tr>
                            <th>Username</th>
                            <th>Admin</th>
                            <th>Change Role</th>
                            <th>Delete</th>
                        </tr>
                    </table>
                </div>

                <div class="admin-table-container" style="float: right;">
                    <table id="postsTable" class="admin-table">
                        <tr>
                            <th>Post Title</th>
                            <th>Length</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="createpost-tab" class="admin-create-post-container" style="display: none;">
                <form action="/posts/create" method="POST" enctype="multipart/form-data">
                    <input type="text" name="postname" class="admin-create-post-title" style="float: left;" placeholder="Enter your post's title.">
                    <input type="file" name="image" class="admin-create-post-upload" style="float: right;">
                    <textarea name="postcontent" class="admin-create-post-textarea" rows="6" cols="60"></textarea>
                    <input type="submit" class="admin-create-post-submit" value="Create Post">
                </form>
            </div>

            <div id="editpost-tab" class="admin-create-post-container" style="display: none;">
                <form method="POST" enctype="multipart/form-data">
                    <input type="text" name="postname" class="admin-create-post-title" style="text-align: center;">
                    <textarea name="postcontent" class="admin-create-post-textarea" rows="6" cols="60"></textarea>
                    <div style="display: flex; justify-content: space-evenly;">
                        <input type="submit" class="admin-create-post-submit" value="Finish Editing">
                        <a class="admin-create-post-submit" onclick="setSelectedTab('editpost-tab', 'database-button')">Cancel</a>
                    </div>
                </form>
                
            </div>
        </div>

        <script>

            function formatEditForm(postid) {
                fetch('/posts/load/' + postid)
                    .then(res => res.json())
                    .then((data) => {
                        if (data.status == 'success') {
                            console.log('success')
                            let parent = document.getElementById('adminContainer')
                            let edittab = document.getElementById('editpost-tab')
                            parent.style.opacity = 1

                            for (let i = 0; i < parent.children.length; i++) {
                                parent.children[i].style.display = "none"
                            }
                            edittab.style.display = "block"

                            document.querySelector('#editpost-tab > form').action = '/posts/edit/' + data.post._id
                            let posttitle = document.querySelector('#editpost-tab > form > input.admin-create-post-title')
                            posttitle.value = data.post.name
                            let postcontent = document.querySelector('#editpost-tab > form > textarea')
                            postcontent.textContent = data.post.content

                        }

                    })
            }

            function setSelectedTab(tabid, buttonid) {
                let parent = document.getElementById('adminContainer')
                let titlebar = document.getElementById('adminTitleBar')
                let buttonelement = document.getElementById(buttonid)
                let tabelement = document.getElementById(tabid)

                if (parent.style.opacity == 0) {
                    for (let i = 0; i < titlebar.children.length; i++) {
                        titlebar.children[i].classList.add('isDisabled')
                    } buttonelement.classList.remove('isDisabled')
                    parent.style.opacity = 1
                } else {
                    for (let i = 0; i < titlebar.children.length; i++) {
                        titlebar.children[i].classList.remove('isDisabled')
                    } parent.style.opacity = 0
                }

                for (let i = 0; i < parent.children.length; i++) {
                    parent.children[i].style.display = "none"
                }
                tabelement.style.display = "block"
            }

            function fillUserTable() {
                fetch('/users/loadall')
                    .then(res => res.json())
                    .then((data) => {
                        if (data.status == 'success') {
                            data.users.forEach((user) => {
                                let parent = document.getElementById('usersTable')
                                let row = document.createElement('tr')

                                // For Username
                                let usernametd = document.createElement('td')
                                usernametd.innerText = user.username
                                row.appendChild(usernametd)

                                // For Admin Status
                                let isadmintd = document.createElement('td')
                                isadmintd.innerText = user.isadmin
                                row.appendChild(isadmintd)

                                // For Change Role Button
                                let changeroletd = document.createElement('td')
                                let changerole = document.createElement('a')
                                changerole.href = '/users/changerole/' + user.username
                                changerole.innerText = 'Change Role'
                                changeroletd.appendChild(changerole)
                                row.appendChild(changeroletd)

                                // For Delete Button
                                let deletebuttontd = document.createElement('td')
                                let deletebutton = document.createElement('a')
                                deletebutton.href = '/users/delete/' + user.username
                                deletebutton.innerText = 'Delete'
                                deletebuttontd.appendChild(deletebutton)
                                row.appendChild(deletebuttontd)

                                parent.appendChild(row)
                            })
                        }
                    })
            }

            function fillPostTable() {
                fetch('/posts/loadall')
                    .then(res => res.json())
                    .then((data) => {
                        if (data.status == 'success') {
                            data.posts.forEach((post) => {
                                let parent = document.getElementById('postsTable')
                                let row = document.createElement('tr')
                                
                                // For Title
                                let postnametd = document.createElement('td')
                                let postname = document.createElement('p')
                                postname.innerText = post.name
                                postnametd.appendChild(postname)
                                row.appendChild(postnametd)

                                // For Length
                                let lengthtd = document.createElement('td')
                                lengthtd.innerText = post.length
                                row.appendChild(lengthtd)

                                // For Edit Button
                                let editbuttontd = document.createElement('td')
                                let editbutton = document.createElement('a')
                                editbutton.onclick = function () {formatEditForm(post._id)}
                                editbutton.innerText = 'Edit'
                                editbuttontd.appendChild(editbutton)
                                row.appendChild(editbuttontd)

                                // For Delete Button
                                let deletebuttontd = document.createElement('td')
                                let deletebutton = document.createElement('a')
                                deletebutton.href = '/posts/delete/' + post._id
                                deletebutton.innerText = 'Delete'
                                deletebuttontd.appendChild(deletebutton)
                                row.appendChild(deletebuttontd)

                                parent.appendChild(row)
                            })
                        }
                    })
            }

            window.onload = function() {
                fillUserTable()
                fillPostTable()
            }

        </script>
    </body>
</html>